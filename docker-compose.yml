# ═══════════════════════════════════════════════════════════════
# Docker Compose for SDS MES Platform - Local Development
# @author Moon Myung-seop
# ═══════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────
  # PostgreSQL Database
  # ─────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: sds-mes-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: sds_mes_dev
      POSTGRES_USER: mes_admin
      POSTGRES_PASSWORD: mes_password_dev_2026
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
      TZ: Asia/Seoul
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/create_schemas.sql:/docker-entrypoint-initdb.d/00_create_schemas.sql:ro
      - ./database/migrations:/docker-entrypoint-initdb.d/migrations:ro
      - ./database/seeds:/docker-entrypoint-initdb.d/seeds:ro
    networks:
      - sds-mes-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mes_admin -d sds_mes_dev"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─────────────────────────────────────────────────────────────
  # Redis Cache
  # ─────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: sds-mes-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass sds_redis_2024
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - sds-mes-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ─────────────────────────────────────────────────────────────
  # Backend (Spring Boot)
  # ─────────────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sds-mes-backend
    restart: unless-stopped
    environment:
      # Spring Profile
      SPRING_PROFILES_ACTIVE: dev

      # Database
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/sds_mes_dev
      SPRING_DATASOURCE_USERNAME: mes_admin
      SPRING_DATASOURCE_PASSWORD: mes_password_dev_2026

      # Redis
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_REDIS_PASSWORD: sds_redis_2024

      # JPA
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "false"

      # JWT
      JWT_SECRET: sds-mes-jwt-secret-key-change-in-production-2024
      JWT_EXPIRATION: 86400000

      # Server
      SERVER_PORT: 8080

      # Timezone
      TZ: Asia/Seoul

      # Java Options
      JAVA_OPTS: "-Xms512m -Xmx1024m -XX:+UseG1GC"
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - sds-mes-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 240s

  # ─────────────────────────────────────────────────────────────
  # Frontend (React + Nginx)
  # ─────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: sds-mes-frontend
    restart: unless-stopped
    environment:
      VITE_API_BASE_URL: /api
      VITE_WS_BASE_URL: /ws
    ports:
      - "3000:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - sds-mes-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

# ═══════════════════════════════════════════════════════════════
# Networks
# ═══════════════════════════════════════════════════════════════
networks:
  sds-mes-network:
    driver: bridge
    name: sds-mes-network

# ═══════════════════════════════════════════════════════════════
# Volumes
# ═══════════════════════════════════════════════════════════════
volumes:
  postgres_data:
    name: sds-mes-postgres-data
  redis_data:
    name: sds-mes-redis-data
